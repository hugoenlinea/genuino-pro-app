<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Cliente - Genuino PRO+</title>
    <link href="https://bootswatch.com/5/superhero/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="Genuino Logo" height="30" class="d-inline-block align-top">
            </a>
            
            <div class="d-flex text-white align-items-center">
                <span class="navbar-text me-3" id="clientNameDisplay">
                    Cargando... </span>
                <button onclick="logout()" class="btn btn-outline-light">Salir</button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        <h2 id="welcomeMessage">Bienvenido</h2>
        <hr>

        <h3 class="mt-4">Mis Cotizaciones Aprobadas</h3>
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Nro. Cotización</th>
                    <th>Fecha</th>
                    <th class="text-end">Monto (Bs.)</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="quotesTableBody">
                </tbody>
        </table>
        
        <h3 class="mt-5">Mis Pedidos</h3>
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Nro. Pedido</th>
                    <th>Fecha de Cotización</th>
                    <th>Estado del Pedido</th>
                </tr>
            </thead>
            <tbody id="ordersTableBody">
                </tbody>
        </table>
    </div>

    <script>
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'decimal',
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        
        // Obtener datos guardados en el login
        const clientId = sessionStorage.getItem('clientId');
        const clientName = sessionStorage.getItem('clientName');

        function checkLogin() {
            if (!clientId || !clientName) {
                // Si no hay datos, redirigir al login
                window.location.href = "{{ url_for('client_login_page') }}";
                return false;
            }
            return true;
        }

        async function loadClientData() {
            if (!checkLogin()) return; // Detener si no está logueado

            // Actualizar los mensajes de bienvenida PRIMERO
            try {
                document.getElementById('welcomeMessage').textContent = `Bienvenido, ${clientName}`;
                document.getElementById('clientNameDisplay').textContent = `Cliente: ${clientName}`;
            } catch (e) {
                console.error("Error al setear nombres:", e);
            }

            // Cargar Cotizaciones
            try {
                const quotesResponse = await fetch(`/api/client/${clientId}/quotes`);
                const quotes = await quotesResponse.json();
                const quotesTable = document.getElementById('quotesTableBody');
                quotesTable.innerHTML = '';
                
                if (quotes.length === 0) {
                    quotesTable.innerHTML = '<tr><td colspan="5" class="text-center">No tiene cotizaciones aprobadas.</td></tr>';
                }

                quotes.forEach(quote => {
                    let statusBadge = `<span class="badge bg-success">${quote.status}</span>`;
                    const pdfLink = `/api/client/${clientId}/quote/${quote.id}/pdf`;
                    
                    quotesTable.innerHTML += `
                        <tr>
                            <td><strong>${quote.quote_number}</strong></td>
                            <td>${new Date(quote.created_at).toLocaleDateString()}</td>
                            <td class="text-end">${formatter.format(quote.total_amount)}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <a href="${pdfLink}" target="_blank" class="btn btn-danger btn-sm">
                                    <i class="bi bi-file-earmark-pdf"></i> PDF
                                </a>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error("Error cargando cotizaciones:", e);
                document.getElementById('quotesTableBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar cotizaciones.</td></tr>';
            }

            // Cargar Pedidos
            try {
                const ordersResponse = await fetch(`/api/client/${clientId}/orders`);
                const orders = await ordersResponse.json();
                const ordersTable = document.getElementById('ordersTableBody');
                ordersTable.innerHTML = '';

                if (orders.length === 0) {
                    ordersTable.innerHTML = '<tr><td colspan="3" class="text-center">No tiene pedidos activos.</td></tr>';
                }

                orders.forEach(order => {
                    ordersTable.innerHTML += `
                        <tr>
                            <td><strong>PED-${order.id}</strong></td>
                            <td>${new Date(order.created_at).toLocaleDateString()}</td>
                            <td><span class="badge bg-info">${order.order_status}</span></td>
                        </tr>
                    `;
                });
            } catch (e) {
                console.error("Error cargando pedidos:", e);
                document.getElementById('ordersTableBody').innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error al cargar pedidos.</td></tr>';
            }
        }
        
        function logout() {
            sessionStorage.removeItem('clientId');
            sessionStorage.removeItem('clientName');
            window.location.href = "{{ url_for('client_login_page') }}";
        }
        
        document.addEventListener('DOMContentLoaded', loadClientData);
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>